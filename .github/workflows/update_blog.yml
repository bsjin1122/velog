name: Update Blog Posts

on:
  push:
    branches:
      - update-blog-posts-branch
  # schedule:
  #   - cron: '*/1 * * * *'
  pull_request:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write


jobs:
  update_blog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
  
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
  
      - name: Install dependencies
        run: |
          pip install feedparser gitpython

      - name: Configure Git
        run: |
          git config --global user.name 'bsjin1122'
          git config --global user.email 'kitty7579@hanmail.net'

      - name: Run script
        run: python scripts/update_velog.py
      
      - name: Check for Changes
        run: |
          git status
          git diff
        id: check_changes

        # --allow-empty 
      - name: Commit and Push Changes
        run: |
          git add .
          git commit --allow-empty -m "Velog posts 업데이트함"
          git push https://${{ secrets.GITHUB_TOKEN }}@github.com/bsjin1122/velog.git update-blog-posts-branch
     
      - name: Set Date Format for PR Title
        run: echo "PR_DATE=$(date '+%y%m%d')" >> $GITHUB_ENV
          
      - name: pull-request
        uses: diillson/auto-pull-request@v1.0.1
        with:
          destination_branch: "main"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "[${{ env.PR_DATE }}]  Velog 게시글 업로드"
          pr_body: |
            :crown: *An automated PR*
        id: create_pr  

      - name: Display PR Number
        run: |
          echo "Pull Request Number: ${{ steps.create_pr.outputs.pr_number }}" 
        
      - name: PR auto approval
        uses: tgymnich/fork-sync@v2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: bsjin1122
          base: main
          head: update-blog-posts-branch
          pr_message: "velog 작성 - PR approve 완료"

      # - name: PR 자동 승인
      #   uses: hmarr/auto-approve-action@v4
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     pull-request-number: ${{ steps.create_pr.outputs.pr_number }}
      #     review-message: "Auto approved automated PR Test"


      # - name: Create Pull Request
      #   uses: peter-evans/create-pull-request@v3
      #   with:
      #     token: ${{ secrets.GITHUB_TOKEN }}
      #     commit-message: "Velog posts 업데이트"
      #     branch: update-blog-posts-branch  # PR 생성 시 사용될 브랜치 이름
      #     title: "PR 자동 생성"
      #     base: main
      
